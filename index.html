<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat InfoMix Botafogo (KB Integrada)</title>
    <!-- Tailwind CSS CDN para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* CSS para o efeito de digita√ß√£o */
        .dot-pulse {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        .dot-pulse.delay-75 { animation-delay: 0.1s; }
        .dot-pulse.delay-150 { animation-delay: 0.2s; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen antialiased">

    <!-- Header Fixo -->
    <header class="bg-white p-4 shadow-md flex justify-between items-center fixed top-0 left-0 right-0 z-10 max-w-lg mx-auto w-full rounded-b-xl">
        <h1 class="text-xl font-bold text-gray-800 flex items-center">
            <svg class="w-6 h-6 mr-2 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm4 3a2 2 0 100-4 2 2 0 000 4zm8 0a2 2 0 100-4 2 2 0 000 4z" />
            </svg>
            Chat InfoMix Botafogo
        </h1>
    </header>

    <!-- Chat Body -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 pt-20 pb-20 space-y-4 max-w-lg w-full mx-auto">
        <!-- Mensagens ser√£o injetadas aqui -->
        <div id="initial-message" class="text-center text-gray-500 mt-10 p-4 bg-white rounded-lg shadow-sm">
            <!-- TEXTO DE INTRODU√á√ÉO ATUALIZADO PARA O SHOPPING -->
            <p>Ol√°! Voc√™ entrou em contato com o Shopping Infomix Botafogo. Em que posso lhe ajudar hoje?</p>
        </div>
        <div id="messages-end"></div>
    </main>

    <!-- Input Footer Fixo -->
    <footer class="bg-white p-3 shadow-t fixed bottom-0 left-0 right-0 z-10 max-w-lg mx-auto w-full rounded-t-xl">
        <form id="chat-form" class="flex space-x-3">
            <input
                type="text"
                id="message-input"
                placeholder="Pergunte sobre lojas, hor√°rios ou servi√ßos..."
                class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                required
            />
            <button
                type="submit"
                id="send-button"
                class="p-3 rounded-full text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-lg disabled:bg-gray-400"
            >
                <svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183.189l4 2A1 1 0 009 19.5h2a1 1 0 00.555-.164l4-2a1 1 0 00.183-.189l-7-14z" />
                </svg>
            </button>
        </form>
    </footer>

    <script>
        // A CHAVE DE API FOI INSERIDA AQUI. ESTE ARQUIVO √â AUTOSSUFICIENTE.
        const API_KEY = "AIzaSyC4u-iH7ONP5zpog-B2XwZy4DGDoSfwfUo";
        const GEMINI_MODEL_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        const chatContainer = document.getElementById('chat-container');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('message-input');
        const messagesEnd = document.getElementById('messages-end');
        const sendButton = document.getElementById('send-button');
        const initialMessage = document.getElementById('initial-message');

        let isLoading = false;

        // 1. Fun√ß√µes de Utilidade
        
        function getMessages() {
            const saved = localStorage.getItem('gemini_html_chat_history');
            return saved ? JSON.parse(saved) : [];
        }

        function saveMessages(messages) {
            localStorage.setItem('gemini_html_chat_history', JSON.stringify(messages));
        }

        function scrollToBottom() {
            messagesEnd.scrollIntoView({ behavior: "smooth" });
        }

        // 2. Renderiza√ß√£o e UI
        
        function createChatBubble(message, isUser) {
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-[85%] p-3 rounded-xl shadow-md whitespace-pre-wrap ${
                isUser 
                ? 'bg-indigo-500 text-white rounded-br-none' 
                : 'bg-gray-200 text-gray-800 rounded-tl-none'
            }`;
            
            // Adiciona quebras de linha (<br>)
            const textWithBreaks = message.replace(/\n/g, '<br>');
            contentDiv.innerHTML = textWithBreaks;
            
            bubbleDiv.appendChild(contentDiv);
            chatContainer.insertBefore(bubbleDiv, messagesEnd);
        }

        function renderHistory() {
            const messages = getMessages();
            if (messages.length > 0) {
                initialMessage.classList.add('hidden');
                messages.forEach(msg => {
                    createChatBubble(msg.text, msg.role === 'user');
                });
                scrollToBottom();
            }
        }

        function setLoading(state) {
            isLoading = state;
            input.disabled = state;
            sendButton.disabled = state;

            const existingLoader = document.getElementById('loader-bubble');
            if (state && !existingLoader) {
                // Cria bolha de "Digitando..."
                const loaderDiv = document.createElement('div');
                loaderDiv.id = 'loader-bubble';
                loaderDiv.className = 'flex justify-start mb-4';
                loaderDiv.innerHTML = `
                    <div class="max-w-xs p-3 rounded-xl shadow-md bg-gray-200 text-gray-800 rounded-tl-none">
                        <div class="flex items-center space-x-1">
                            <span class="dot-pulse w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                            <span class="dot-pulse w-2 h-2 rounded-full bg-indigo-500 animate-pulse delay-75"></span>
                            <span class="dot-pulse w-2 h-2 rounded-full bg-indigo-500 animate-pulse delay-150"></span>
                            <span class="text-sm ml-2">Digitando...</span>
                        </div>
                    </div>
                `;
                chatContainer.insertBefore(loaderDiv, messagesEnd);
            } else if (!state && existingLoader) {
                // Remove bolha de "Digitando..."
                existingLoader.remove();
            }
            scrollToBottom();
        }

        // 3. L√≥gica de Comunica√ß√£o com a IA

        async function generateResponse(messages) {
            const chatHistory = messages
                .map(m => ({
                    role: m.role,
                    parts: [{ text: m.text }]
                }));
            
            // --- INSTRU√á√ÉO DO SISTEMA ATUALIZADA COM TODA A BASE DE CONHECIMENTO ---
            const systemPrompt = `
    Voc√™ √© o "Shopping Infomix Botafogo Bot", um assistente de IA focado em fornecer informa√ß√µes sobre o Shopping Infomix Botafogo.
    
    INSTRU√á√ÉO CR√çTICA: Use a BASE DE CONHECIMENTO fornecida abaixo como sua principal fonte de informa√ß√£o para responder √†s consultas. Se uma pergunta n√£o estiver claramente coberta pela Base de Conhecimento, use a ferramenta de busca do Google para obter dados atuais (como hor√°rios ou novas lojas), mas mantenha a personalidade do bot do shopping.

    Responda em portugu√™s, usando uma linguagem clara, informativa e acolhedora, e mantenha as respostas concisas.

    --- BASE DE CONHECIMENTO (KB) ---
    
    1. Inten√ß√µes de Sauda√ß√£o e Apresenta√ß√£o
    Inten√ß√£o: Saudacao
    ‚Ä¢ Exemplos de usu√°rio: "Oi", "Ol√°", "Bom dia", "Tudo bem?"
    ‚Ä¢ Resposta do Chatbot: "Ol√°! Eu sou o assistente virtual do Shopping Infomix Botafogo. Temos diversas lojas especializadas em assist√™ncia t√©cnica e produtos de inform√°tica. Como posso ajudar voc√™ hoje?"
    
    Inten√ß√£o: Sobre_A_Empresa
    ‚Ä¢ Exemplos de usu√°rio: "O que √© a InfoMix?", "Quem s√£o voc√™s?", "Voc√™s s√£o uma loja?"
    ‚Ä¢ Resposta do Chatbot: "O Infomix Botafogo √© um shopping de inform√°tica e tecnologia em Botafogo (RJ), com mais de 18 anos de tradi√ß√£o. Reunimos diversas lojas f√≠sicas especializadas em consertos, manuten√ß√£o e venda de acess√≥rios."
    
    2. Inten√ß√µes de Contato
    Inten√ß√£o: Contato_WhatsApp
    ‚Ä¢ Exemplos de usu√°rio: "Qual o WhatsApp?", "Posso falar com algu√©m?", "Quero um or√ßamento"
    ‚Ä¢ Resposta do Chatbot: "Claro! Nosso n√∫mero principal de contato e WhatsApp √© (21) 96478-1947. Pode nos chamar por l√° para tirar d√∫vidas ou solicitar or√ßamentos com nossas lojas."
    
    Inten√ß√£o: Contato_Telefone
    ‚Ä¢ Exemplos de usu√°rio: "Qual o telefone fixo?", "Posso ligar?"
    ‚Ä¢ Resposta do Chatbot: "Nosso canal de atendimento principal √© o WhatsApp (21) 96478-1947. Por l√°, conseguimos direcionar sua solicita√ß√£o para a loja certa."
    
    3. Inten√ß√µes de Localiza√ß√£o e Hor√°rio
    Inten√ß√£o: Localizacao_Endereco
    ‚Ä¢ Exemplos de usu√°rio: "Onde fica a loja?", "Qual o endere√ßo?", "√â perto do metr√¥?"
    ‚Ä¢ Resposta do Chatbot: "Estamos localizados na Rua Volunt√°rios da P√°tria, 261, em Botafogo, Rio de Janeiro - RJ (CEP: 22270-003)."
    
    Inten√ß√£o: Horario_Funcionamento
    ‚Ä¢ Exemplos de usu√°rio: "Qual o hor√°rio de funcionamento?", "Voc√™s abrem hoje?", "Abre aos s√°bados?"
    ‚Ä¢ Resposta do Chatbot: "Nosso shopping re√∫ne diversas lojas, cada uma pode ter um hor√°rio espec√≠fico. Para confirmar o hor√°rio de funcionamento do shopping ou de uma loja espec√≠fica, por favor, entre em contato pelo nosso WhatsApp (21) 96478-1947."
    
    4. Inten√ß√µes de Servi√ßos (Assist√™ncia T√©cnica)
    Inten√ß√£o: Servicos_Gerais
    ‚Ä¢ Exemplos de usu√°rio: "O que voc√™s consertam?", "Quais servi√ßos voc√™s oferecem?", "Voc√™s d√£o manuten√ß√£o?"
    ‚Ä¢ Resposta do Chatbot: "Temos lojas com assist√™ncias t√©cnicas de alto padr√£o! Nossas especialidades incluem:
    ‚Ä¢ Inform√°tica (Notebooks, Macbooks, Computadores)
    ‚Ä¢ Celulares, Tablets e iPads
    ‚Ä¢ Impressoras
    ‚Ä¢ Videogames (Consoles)
    ‚Ä¢ TVs
    ‚Ä¢ Eletrodom√©sticos (Adegas, Geladeiras, M√°quinas de Lavar)
    O que voc√™ precisa consertar?"
    
    Inten√ß√£o: Servico_Notebook_PC
    ‚Ä¢ Exemplos de usu√°rio: "Conserta notebook?", "Meu PC quebrou", "Voc√™s arrumam Macbook?", "Formata√ß√£o"
    ‚Ä¢ Resposta do Chatbot: "Sim! Temos lojas especializadas no conserto de Notebooks, Macbooks e Desktops (Computadores) de diversas marcas, como Dell, Samsung, Apple, Acer, Asus, Lenovo, entre outras."
    
    Inten√ß√£o: Servico_Celular_Tablet
    ‚Ä¢ Exemplos de usu√°rio: "Troca tela de celular?", "Conserta iPhone?", "Meu tablet n√£o liga"
    ‚Ä¢ Resposta do Chatbot: "Com certeza. Nossas assist√™ncias t√©cnicas s√£o muito bem avaliadas no conserto de celulares (incluindo iPhones) e tablets (como iPads e Samsung)."
    
    Inten√ß√£o: Servico_Impressora
    ‚Ä¢ Exemplos de usu√°rio: "Minha impressora n√£o puxa papel", "Conserto de impressora HP"
    ‚Ä¢ Resposta do Chatbot: "Sim, somos especialistas em conserto de impressoras na Zona Sul. Trabalhamos com as principais marcas, como Epson, HP, Canon, Lexmark e Samsung."
    
    Inten√ß√£o: Servico_Videogame
    ‚Ä¢ Exemplos de usu√°rio: "Conserta PS5?", "Meu Xbox n√£o liga", "Assist√™ncia Nintendo Switch"
    ‚Ä¢ Resposta do Chatbot: "Sim! Al√©m da assist√™ncia tradicional, temos conserto especializado para consoles de nova gera√ß√£o, como PlayStation 5 (PS5), Xbox Series S e Nintendo Switch."
    
    Inten√ß√£o: Servico_Outros_Eletros
    ‚Ä¢ Exemplos de usu√°rio: "Conserta TV?", "Minha adega parou de gelar", "Arruma m√°quina de lavar?"
    ‚Ä¢ Resposta do Chatbot: "Sim, temos lojas que oferecem assist√™ncia para TVs, Adegas, Geladeiras, M√°quinas Lava e Seca, Ar Condicionado e at√© Caixas de Som."
    
    Inten√ß√£o: Servico_LanHouse
    ‚Ä¢ Exemplos de usu√°rio: "Tem Lan House?", "Preciso imprimir um documento", "Tira xerox?"
    ‚Ä¢ Resposta do Chatbot: "Temos sim! Nossa Lan House oferece acesso √† internet, impress√£o, XEROX, scanner, digita√ß√£o, foto 3x4, consultas (SPC/Serasa) e emiss√£o de 2¬™ via de contas."
    
    5. Inten√ß√µes de Produtos (Venda)
    Inten√ß√£o: Produtos_Gerais
    ‚Ä¢ Exemplos de usu√°rio: "O que voc√™s vendem?", "Tem acess√≥rios?", "Preciso de um cabo"
    ‚Ä¢ Resposta do Chatbot: "Nossas lojas vendem uma grande variedade de produtos e acess√≥rios de inform√°tica e para celulares. O que voc√™ est√° procurando?"
    
    Inten√ß√£o: Produtos_Informatica
    ‚Ä¢ Exemplos de usu√°rio: "Vende carregador de notebook?", "Tem teclado?", "Preciso de um SSD"
    ‚Ä¢ Resposta do Chatbot: "Sim, temos acess√≥rios de inform√°tica como:
    ‚Ä¢ Fontes e carregadores de notebook
    ‚Ä¢ Mouses e Teclados (com e sem fio)
    ‚Ä¢ SSDs e HDs (para upgrade)
    ‚Ä¢ Mem√≥rias RAM
    ‚Ä¢ Cabos variados (HDMI, Rede, etc.)
    ‚Ä¢ Webcams"
    
    Inten√ß√£o: Produtos_Celular
    ‚Ä¢ Exemplos de usu√°rio: "Vende capa de celular?", "Tem pel√≠cula?", "Fone de ouvido"
    ‚Ä¢ Resposta do Chatbot: "Sim, temos diversos acess√≥rios para celulares, como capas, pel√≠culas, fones de ouvido, carregadores, cabos, cart√µes de mem√≥ria e baterias externas."
    
    Inten√ß√£o: Produtos_Outros
    ‚Ä¢ Exemplos de usu√°rio: "Vende cartucho de impressora?", "Tem controle remoto de TV?"
    ‚Ä¢ Resposta do Chatbot: "Sim, em nossas lojas voc√™ tamb√©m encontra cartuchos para impressoras e acess√≥rios espec√≠ficos, como controles remotos originais para TV."
    --- FIM DA BASE DE CONHECIMENTO ---
`;
            // --------------------------------------------------------------------------

            const payload = {
                contents: chatHistory,
                // Mant√©m o tool 'google_search' ativo, mesmo com a KB, para buscar dados em tempo real quando necess√°rio
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const url = `${GEMINI_MODEL_URL}?key=${API_KEY}`;
            let response;
            let currentDelay = 1000;
            const maxRetries = 3;

            try {
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break;
                    }
                    
                    // --- NOVA L√ìGICA DE TRATAMENTO DE ERROS CHAVE (400, 403, 404) ---
                    if (response.status === 403 || response.status === 400 || response.status === 404) {
                        const errorBody = await response.text();
                        console.error(`Erro Cr√≠tico na API (Status ${response.status}):`, errorBody);
                        let errorMessage = `Erro de API (Status: ${response.status}).`;
                        if (errorBody.includes("API key not valid") || response.status === 403) {
                            errorMessage = "ERRO FATAL: Chave API inv√°lida ou expirada. Verifique se a chave est√° correta.";
                        } else if (response.status === 404) {
                            errorMessage = "ERRO 404: Endpoint da API n√£o encontrado. O URL do modelo pode estar incorreto.";
                        } else if (response.status === 429) {
                            errorMessage = "ERRO 429: Limite de cota excedido. Tente novamente mais tarde.";
                        }
                        // Lan√ßa o erro imediatamente para evitar o loop de retentativa em erros fatais
                        throw new Error(errorMessage);
                    }
                    // -------------------------------------------------------------

                    if (i < maxRetries - 1) {
                        // Tenta novamente com backoff exponencial
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                    } else {
                        throw new Error(`Erro na API: ${response.status} - ${await response.text()}`);
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("Falha na chamada da API ap√≥s todas as retentativas.");
                }

                const result = await response.json();
                
                // Adiciona verifica√ß√£o de bloqueio de seguran√ßa
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                    const reason = result.promptFeedback.blockReason;
                    console.warn("Resposta bloqueada por filtro de seguran√ßa:", reason);
                    return "Desculpe, a pergunta foi bloqueada pelo filtro de seguran√ßa. Motivo: " + reason;
                }
                
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Desculpe, n√£o consegui gerar uma resposta (resposta vazia).";

            } catch (error) {
                // Captura o erro customizado e exibe para o usu√°rio
                console.error("Erro capturado:", error.message);
                
                // Retorna a mensagem de erro espec√≠fica ou uma mensagem gen√©rica de falha
                if (error.message.includes("ERRO FATAL") || error.message.includes("ERRO 404") || error.message.includes("ERRO 429")) {
                    return "üõë " + error.message;
                }

                return "‚ùå N√£o foi poss√≠vel conectar ao Gemini. Verifique sua chave API, rede ou limites de uso.";
            }
        }

        // 4. Tratamento do Evento de Envio
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = input.value.trim();
            if (!messageText || isLoading) return;
            
            initialMessage.classList.add('hidden');
            setLoading(true);
            input.value = '';

            let messages = getMessages();
            
            // 4a. Mensagem do Usu√°rio
            const userMessage = { role: 'user', text: messageText };
            messages.push(userMessage);
            saveMessages(messages);
            createChatBubble(userMessage.text, true);

            // 4b. Chamada √† IA
            const geminiResponseText = await generateResponse(messages);

            // 4c. Mensagem do Gemini
            const geminiMessage = { role: 'gemini', text: geminiResponseText };
            
            // S√≥ salva a mensagem do Gemini no hist√≥rico se n√£o for uma mensagem de erro fatal
            if (!geminiResponseText.startsWith("üõë") && !geminiResponseText.startsWith("‚ùå")) {
                messages.push(geminiMessage);
                saveMessages(messages);
            }
            
            setLoading(false); // Remove o loader antes de adicionar a resposta
            createChatBubble(geminiResponseText, false);
            scrollToBottom();
        });

        // 5. Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', renderHistory);

    </script>
</body>
</html>
